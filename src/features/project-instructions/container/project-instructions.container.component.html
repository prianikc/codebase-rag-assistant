<div class="pi-overlay" (click)="onClose()">
  <div class="pi-card" (click)="$event.stopPropagation()">

    <!-- Header -->
    <div class="pi-header">
      <div class="pi-title">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É
      </div>
      <div class="pi-header-actions">
        @if (instructionsService.instructions().size > 0) {
          <button class="pi-btn pi-btn--export" (click)="exportAll()" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ Markdown">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            –≠–∫—Å–ø–æ—Ä—Ç
          </button>
        }
        <button class="pi-close" (click)="onClose()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Body -->
    <div class="pi-body">

      <!-- No files state -->
      @if (!hasFiles()) {
        <div class="pi-empty">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
              d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
          </svg>
          <p>–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞</p>
          <span>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ä–µ–∑ GitHub</span>
        </div>
      } @else {

        <!-- Generate Button -->
        @if (instructionsService.instructions().size === 0 && !instructionsService.isGenerating()) {
          <div class="pi-start">
            <div class="pi-start-info">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
              </svg>
              <div>
                <h3>–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞</h3>
                <p>–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞–∂–¥—É—é –ø–∞–ø–∫—É –∏ –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –ø—Ä–æ–µ–∫—Ç–∞, —Å–æ–∑–¥–∞—Å—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
                  —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º, —Å—É—â–Ω–æ—Å—Ç—è–º–∏, —Å–æ–≤–µ—Ç–∞–º–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é.</p>
              </div>
            </div>
            <button class="pi-btn pi-btn--generate" (click)="generate()">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            </button>
          </div>
        }

        <!-- Progress -->
        @if (instructionsService.isGenerating() || instructionsService.progressStatus()) {
          <div class="pi-progress">
            @if (instructionsService.isGenerating()) {
              <div class="pi-progress-bar">
                <div class="pi-progress-fill" [style.width.%]="instructionsService.progress()"></div>
              </div>
            }
            <div class="pi-progress-text">{{ instructionsService.progressStatus() }}</div>
          </div>
        }

        <!-- Content: Tree + Detail -->
        @if (instructionsService.instructions().size > 0) {
          <div class="pi-content">

            <!-- Tree -->
            <div class="pi-tree">
              <div class="pi-tree-header">
                <span>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞</span>
                <span class="pi-tree-count">
                  {{ instructionsService.completedItems() }}/{{ instructionsService.totalItems() }}
                </span>
              </div>
              <div class="pi-tree-list">
                <ng-template #nodeTemplate let-nodes="nodes">
                  @for (node of nodes; track node.path) {
                    <div>
                      <div
                        (click)="selectItem(node.path, node.type)"
                        [class]="'pi-tree-node' + (selectedPath() === node.path ? ' active' : '') + ' pi-tree-node--' + node.type"
                        [style.padding-left.px]="node.level * 16 + 12">

                        <!-- Folder toggle -->
                        @if (node.type === 'folder' && node.children.length > 0) {
                          <button class="pi-tree-toggle" (click)="$event.stopPropagation(); toggleNode(node)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                              [style.transform]="isOpen(node.path) ? 'rotate(90deg)' : 'rotate(0)'"
                              style="transition:transform 0.2s;">
                              <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd" />
                            </svg>
                          </button>
                        }

                        <!-- Icon -->
                        @if (node.type === 'folder') {
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                            class="pi-tree-icon pi-tree-icon--folder">
                            <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                          </svg>
                        } @else {
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                            class="pi-tree-icon pi-tree-icon--file">
                            <path fill-rule="evenodd"
                              d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                              clip-rule="evenodd" />
                          </svg>
                        }

                        <span class="pi-tree-name">{{ node.name }}</span>

                        <!-- Status -->
                        @if (node.folderInstruction) {
                          <span [class]="'pi-tree-status ' + getStatusClass(node.folderInstruction.status)">
                            {{ getStatusIcon(node.folderInstruction.status) }}
                          </span>
                        }
                        @if (node.fileInstruction) {
                          <span [class]="'pi-tree-status ' + getStatusClass(node.fileInstruction.status)">
                            {{ getStatusIcon(node.fileInstruction.status) }}
                          </span>
                        }
                      </div>

                      @if (node.type === 'folder' && node.children.length > 0 && isOpen(node.path)) {
                        <ng-container *ngTemplateOutlet="nodeTemplate; context: { nodes: node.children }">
                        </ng-container>
                      }
                    </div>
                  }
                </ng-template>

                <ng-container *ngTemplateOutlet="nodeTemplate; context: { nodes: treeNodes() }"></ng-container>
              </div>
            </div>

            <!-- Detail Panel -->
            <div class="pi-detail">
              @if (selectedContent()) {
                <div class="pi-detail-header">
                  <div class="pi-detail-path">
                    @if (selectedType() === 'folder') {
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                      </svg>
                    } @else {
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                          d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                          clip-rule="evenodd" />
                      </svg>
                    }
                    {{ selectedPath() }}
                  </div>
                  <div class="pi-detail-actions">
                    @if (isFolderInstruction(selectedContent())) {
                      <span class="pi-detail-files">{{ $any(selectedContent()).files.length }} —Ñ–∞–π–ª–æ–≤</span>
                    }
                    <span class="pi-detail-type-badge"
                      [class.pi-detail-type-badge--folder]="selectedType() === 'folder'"
                      [class.pi-detail-type-badge--file]="selectedType() === 'file'">
                      {{ selectedType() === 'folder' ? 'üìÅ –ü–∞–ø–∫–∞' : 'üìÑ –§–∞–π–ª' }}
                    </span>
                    <button class="pi-btn pi-btn--regen" (click)="regenerateSelected()"
                      [disabled]="instructionsService.isGenerating()" title="–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                    </button>
                  </div>
                </div>
                <div class="pi-detail-body">
                  @if (selectedContent()!.status === 'generating') {
                    <div class="pi-detail-loading">
                      <div class="spinner-ring"></div>
                      <span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>
                    </div>
                  } @else if (selectedContent()!.status === 'error') {
                    <div class="pi-detail-error">
                      ‚ö†Ô∏è {{ selectedContent()!.error }}
                    </div>
                  } @else if (selectedContent()!.status === 'done') {
                    <div class="pi-detail-content" [innerHTML]="selectedContent()!.instruction | markdown">
                    </div>
                  } @else {
                    <div class="pi-detail-pending">
                      –û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...
                    </div>
                  }
                </div>
              } @else {
                <div class="pi-detail-empty">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p>
                </div>
              }
            </div>

          </div>
        }
      }
    </div>

  </div>
</div>
