<div style="display:flex;flex-direction:column;flex:1;min-height:0;position:relative;">
  <!-- Settings Modal -->
  @if (showSettings) {
    <app-settings-container (close)="toggleSettings()"></app-settings-container>
  }

  <!-- Header -->
  <div class="chat-header">
    <div class="chat-header-left">
      <div class="status-dot"></div>
      <div>
        <div class="chat-header-title">RAG Assistant</div>
        <div class="chat-header-session">{{ currentSessionTitle() }}</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <!-- Export Button -->
      <button class="export-btn" (click)="exportChat()" title="Экспортировать чат в Markdown">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Экспорт
      </button>

      <!-- Settings Button -->
      <button class="settings-btn" (click)="toggleSettings()">
        <span [innerHTML]="modelLabel()"></span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Messages Area -->
  <div class="messages-area" #scrollContainer>
    @if (messages().length === 0) {
      <div class="empty-state">
        <div class="empty-state-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
          </svg>
        </div>
        <span class="empty-state-text">Система готова</span>

        <div class="presets-grid">
          <span
            style="grid-column:1/-1;text-align:center;font-size:10px;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">
            Быстрые действия
          </span>
          @for (preset of presets; track preset) {
            <button class="preset-btn" (click)="usePreset(preset)">
              <span>{{ preset }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </button>
          }
        </div>
      </div>
    }

    @for (msg of messages(); track msg.timestamp) {
      <app-message-bubble
        [role]="msg.role"
        [content]="msg.content"
        [timestamp]="msg.timestamp"
        [sources]="msg.sources"
        [isStreaming]="isGenerating() && msg === lastMessage()">
      </app-message-bubble>
    }

    @if (isGenerating() && step() !== 'generating') {
      <div class="message-row message-row--assistant">
        <div class="progress-indicator">
          <div class="progress-dot"></div>
          <span class="progress-text">
            @if (step() === 'retrieving') { Анализ запроса и поиск по кодовой базе... }
          </span>
        </div>
      </div>
    }
  </div>

  <!-- Input Area -->
  <app-chat-input
    [value]="userInput"
    [useRag]="useRag"
    [disabled]="isGenerating()"
    [docCount]="vectorStore.docCount()"
    (valueChange)="userInput = $event"
    (useRagChange)="useRag = $event"
    (send)="triggerSend()">
  </app-chat-input>
</div>
