<div class="file-viewer-panel" (mouseup)="onMouseUp()">
    <!-- Header -->
    <div class="fv-header">
        <div class="fv-header-left">
            <div class="fv-file-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                        clip-rule="evenodd" />
                </svg>
            </div>
            <div class="fv-file-info">
                <span class="fv-file-name">{{ getFileName() }}</span>
                <span class="fv-file-path">{{ viewerService.currentFilePath() }}</span>
            </div>
        </div>
        <div class="fv-header-actions">
            @if (getFileExtension()) {
                <span class="fv-lang-badge">{{ getFileExtension() }}</span>
            }
            <span class="fv-line-count">{{ viewerService.fileLines().length }} lines</span>
            <button class="fv-close-btn" (click)="close.emit()" title="Close viewer">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Selection Toolbar -->
    @if (selectionRanges().length > 0 || textSelectionSnippets().length > 0 || allSelectedCode()) {
        <div class="fv-selection-bar">
            <div class="fv-selection-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="fv-selection-count">
                    @if (selectionRanges().length > 0) {
                        {{ selectionRanges().length }} {{ selectionRanges().length === 1 ? '–¥–∏–∞–ø–∞–∑–æ–Ω —Å—Ç—Ä–æ—á–µ–∫' : '–¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤' }}
                        ‚Ä¢ {{ totalSelectedLines() }} —Å—Ç—Ä–æ–∫
                    }
                    @if (textSelectionSnippets().length > 0) {
                        ‚Ä¢ –§—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ —Ç–µ–∫—Å—Ç–∞: {{ textSelectionSnippets().length }}
                    }
                </span>
            </div>

            <!-- Selection ranges chips -->
            <div class="fv-ranges-list">
                @for (range of selectionRanges(); track $index; let i = $index) {
                    <span class="fv-range-chip">
                        {{ getRangeLabel(range) }}
                        <button class="fv-chip-action fv-chip-action--send" (click)="insertSingleRange(i)" title="–í—Å—Ç–∞–≤–∏—Ç—å –≤ —á–∞—Ç">üí¨</button>
                        <button class="fv-range-remove" (click)="removeRange(i)" title="–£–±—Ä–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω">√ó</button>
                    </span>
                }
                @for (text of textSelectionSnippets(); track $index; let i = $index) {
                    <span class="fv-range-chip">
                        –¢–µ–∫—Å—Ç ({{ text.text.length }} —Å–∏–º–≤.)
                        <button class="fv-chip-action fv-chip-action--send" (click)="insertSingleText(i)" title="–í—Å—Ç–∞–≤–∏—Ç—å –≤ —á–∞—Ç">üí¨</button>
                        <button class="fv-range-remove" (click)="removeTextSnippet(i)" title="–£–±—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç">√ó</button>
                    </span>
                }
            </div>

            <div class="fv-selection-actions">
                <button class="fv-action-btn fv-action-btn--clear" (click)="clearSelection()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    –°–±—Ä–æ—Å–∏—Ç—å
                </button>
                <button class="fv-action-btn fv-action-btn--insert" (click)="onInsertToChat()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    –í—Å—Ç–∞–≤–∏—Ç—å –≤ —á–∞—Ç
                </button>
            </div>
        </div>
    }

    <!-- Hint bar -->
    <div class="fv-hint-bar">
        <span>üí° –ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –Ω–æ–º–µ—Ä–∞–º —Å—Ç—Ä–æ–∫ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è ‚Ä¢ <strong>Shift</strong> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω ‚Ä¢ <strong>Ctrl</strong> ‚Äî –Ω–æ–≤—ã–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω ‚Ä¢ –ò–ª–∏ –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –º—ã—à–∫–æ–π</span>
    </div>

    <!-- Code Area -->
    <div class="fv-code-area" #codeContainer (mouseup)="onTextSelect($event)">
        @if (viewerService.isLoading()) {
            <div class="fv-loading">
                <div class="fv-spinner"></div>
                <span>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</span>
            </div>
        } @else if (highlightedLines().length === 0) {
            <div class="fv-empty">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span>–§–∞–π–ª –ø—É—Å—Ç</span>
            </div>
        } @else {
            <table class="fv-code-table">
                <tbody>
                    @for (line of highlightedLines(); track $index; let i = $index) {
                        <tr class="fv-line"
                            [class.fv-line--selected]="isLineSelected(i)">
                            <td class="fv-line-number"
                                (mousedown)="onLineMouseDown(i, $event)"
                                (mouseenter)="onLineMouseEnter(i)">{{ i + 1 }}</td>
                            <td class="fv-line-content" [innerHTML]="line || '&nbsp;'"></td>
                        </tr>
                        <tr class="fv-actions-row"
                            [style.display]="getRangeEndingAt(i) !== -1 ? 'table-row' : 'none'">
                            <td></td>
                            <td class="fv-actions-cell">
                                <button class="fv-action-inline" (click)="removeRange(getRangeEndingAt(i))">reset</button>
                                <button class="fv-action-inline fv-action-inline--send" (click)="insertSingleRange(getRangeEndingAt(i))">to chat</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>
