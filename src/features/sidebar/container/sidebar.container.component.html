<div style="display:flex;flex-direction:column;height:100%;position:relative;">

  <!-- Confirmation Modal Overlay -->
  @if (showConfirmModal()) {
    <app-confirmation-modal
      [title]="confirmTitle()"
      [message]="confirmMessage()"
      (confirm)="onConfirmAction()"
      (cancel)="onCancelAction()">
    </app-confirmation-modal>
  }

  <!-- Logo -->
  <div class="sidebar-header">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
      </div>
      <div>
        <div class="sidebar-logo-text">RAG Assistant</div>
        <div class="sidebar-logo-version">v1.0.0</div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="sidebar-tabs">
    <button (click)="activeTab.set('files')" [class]="'sidebar-tab' + (activeTab() === 'files' ? ' active' : '')">
      –§–∞–π–ª—ã
    </button>
    <button (click)="activeTab.set('chats')" [class]="'sidebar-tab' + (activeTab() === 'chats' ? ' active' : '')">
      –ß–∞—Ç—ã
    </button>
  </div>

  <!-- FILES TAB -->
  @if (activeTab() === 'files') {
    <div class="sidebar-content">
      <!-- Import Buttons -->
      <div class="import-grid">
        <label class="import-btn import-btn--folder">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          </svg>
          –ü–∞–ø–∫–∞
          <input #folderInput type="file" webkitdirectory directory multiple style="display:none;"
            (change)="onFilesSelected($event, folderInput)">
        </label>

        <label class="import-btn import-btn--files">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          –§–∞–π–ª—ã
          <input #filesInput type="file" multiple style="display:none;"
            (change)="onFilesSelected($event, filesInput)">
        </label>

        <button class="import-btn import-btn--github" [class.active]="showRepoInput" (click)="toggleRepoInput()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          GitHub
        </button>
      </div>

      <!-- GitHub Input -->
      @if (showRepoInput) {
        <div class="github-input-area">
          <div class="github-input-row">
            <input type="text" class="github-input" [(ngModel)]="repoUrl" placeholder="owner/repo"
              (keydown.enter)="prepareRepoLoad()">
            <button class="github-submit" (click)="prepareRepoLoad()"
              [disabled]="kbService.isIngesting() || !repoUrl.trim()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                  clip-rule="evenodd" />
              </svg>
            </button>
          </div>
          <p class="github-hint">–Ω–∞–ø—Ä–∏–º–µ—Ä: angular/angular</p>
        </div>
      }

      @if (kbService.progressStatus()) {
        <div class="ingest-progress">{{ kbService.progressStatus() }}</div>
      }

      <!-- Instructions Button -->
      @if (vectorStore.docCount() > 0) {
        <button class="import-btn import-btn--instructions" (click)="openInstructions.emit()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É
        </button>
      }

      <!-- Stats -->
      <div class="stats-bar">
        <div class="stat-item">
          <div class="stat-dot stat-dot--files"></div>
          –§–∞–π–ª–æ–≤: {{ kbService.totalFiles() }}
        </div>
        <div class="stat-item">
          <div class="stat-dot stat-dot--vectors"></div>
          –í–µ–∫—Ç–æ—Ä–æ–≤: {{ vectorStore.docCount() }}
          @if (vectorStore.docCount() > 0) {
            <button class="clear-vectors-btn" (click)="confirmClearVectors()" title="–û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –≤–µ–∫—Ç–æ—Ä–æ–≤">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                  clip-rule="evenodd" />
              </svg>
            </button>
          }
        </div>
      </div>

      <!-- Tree Controls -->
      @if (treeNodes().length > 0) {
        <div style="display:flex;justify-content:flex-end;margin-bottom:4px;">
          <div class="tree-controls">
            <button class="tree-control-btn" (click)="expandAll()" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            </button>
            <button class="tree-control-btn" (click)="collapseAll()" title="–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
              </svg>
            </button>
          </div>
        </div>
      }

      <!-- Tree View / States -->
      @if (kbService.isIngesting()) {
        <div class="loading-spinner">
          <div class="spinner-ring"></div>
          <span class="spinner-text">–û–ë–†–ê–ë–û–¢–ö–ê...</span>
        </div>
      } @else if (treeNodes().length === 0) {
        <div class="empty-files">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
              d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
          </svg>
          <p>–§–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
        </div>
      } @else {
        <ng-template #nodeTemplate let-nodes="nodes">
          @for (node of nodes; track node.path) {
            <div>
              <div (click)="toggleNode(node)" [class]="'tree-node tree-node--' + node.type + (node.type === 'file' && fileViewerService.currentFilePath() === node.path ? ' tree-node--active' : '')"
                [style.padding-left.px]="node.level * 12 + 8">

                @if (node.type === 'folder') {
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                    [style.transform]="node.isOpen ? 'rotate(0)' : 'rotate(-90deg)'"
                    style="transition:transform 0.2s;">
                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                  </svg>
                } @else {
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                      d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                      clip-rule="evenodd" />
                  </svg>
                }

                <span>{{ node.name }}</span>
              </div>

              @if (node.type === 'folder' && node.isOpen) {
                <ng-container *ngTemplateOutlet="nodeTemplate; context: { nodes: node.children }"></ng-container>
              }
            </div>
          }
        </ng-template>

        <ng-container *ngTemplateOutlet="nodeTemplate; context: { nodes: treeNodes() }"></ng-container>
      }
    </div>
  }

  <!-- CHATS TAB -->
  @else {
    <div class="sidebar-content">
      <button class="new-chat-btn" (click)="chatService.createNewSession()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          style="width:14px;height:14px;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        –ù–æ–≤—ã–π —á–∞—Ç
      </button>

      @for (session of chatService.sessions(); track session.id) {
        <div (click)="chatService.selectSession(session.id)"
          [class]="'chat-session' + (chatService.currentSessionId() === session.id ? ' active' : '')">
          <div style="overflow:hidden;">
            <div class="chat-session-title">{{ session.title }}</div>
            <div class="chat-session-meta">
              {{ session.messages.length }} —Å–æ–æ–±—â. ‚Ä¢ {{ session.lastUpdate | date:'shortDate' }}
            </div>
          </div>
          <button class="chat-session-delete" (click)="$event.stopPropagation(); deleteSession(session.id)"
            title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
              style="width:12px;height:12px;">
              <path fill-rule="evenodd"
                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      }
    </div>
  }
</div>
